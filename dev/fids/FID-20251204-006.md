# FID-20251204-006: Drug Trading Mini-Game & Tutorial System

**Status:** PLANNED
**Priority:** P1 (High)
**Complexity:** 4 (Complex)
**Estimated:** 16-24h
**Created:** 2025-12-04

## Summary
Create an interactive "Dope Wars" style drug trading mini-game where players can actively buy/sell drugs across 50 US states with real-time varying prices, combined with an onboarding tutorial system to guide new players through the crime operations interface.

## Problem Statement
The current Crime Operations system has significant usability issues:
1. **No player inventory** - Players have no concept of "owning" drugs
2. **No buy/sell mechanism** - The marketplace is for NPCs, not player trading
3. **Confusing UI** - Modal text appears black on dark background (FIXED)
4. **No onboarding** - New players don't understand how to use the system
5. **No price variation** - Static pricing with no arbitrage opportunities
6. **No gameplay loop** - Nothing to actually DO in the system

## Acceptance Criteria

### Trading Mini-Game
- [ ] Player Inventory System - Track player-owned drugs with quantity, purity, location
- [ ] 50-State Pricing Engine - Dynamic prices per state with variation over time
- [ ] Buy Interface - Purchase from NPCs/marketplace with quantity selection
- [ ] Sell Interface - Sell to NPCs with profit/loss display
- [ ] Travel System - Move between states (time + risk + cost)
- [ ] Real-time Price Updates - Prices fluctuate based on supply/demand/events
- [ ] Price Charts - Historical price display per substance per state
- [ ] Arbitrage Detection - Visual indicators for price differences
- [ ] Risk System - Higher quantities = higher heat gain

### Tutorial System
- [ ] Interactive guided tour using react-joyride
- [ ] Step-by-step walkthrough of Crime Operations
- [ ] Dismissable/skippable with "don't show again"
- [ ] Contextual help tooltips
- [ ] Tutorial progress tracking per user

## Technical Design

### New Models

#### PlayerInventory (NEW)
```typescript
interface IPlayerInventory {
  userId: ObjectId;
  items: {
    substance: string;
    quantity: number;
    purity: number;
    avgPurchasePrice: number;
    location: { state: string; city?: string };
    acquiredAt: Date;
  }[];
  cash: number;
  updatedAt: Date;
}
```

#### StatePricing (NEW)
```typescript
interface IStatePricing {
  state: string; // "CA", "NY", etc.
  prices: {
    substance: string;
    basePrice: number;
    currentPrice: number;
    volatility: number; // 0-100
    demand: number; // 0-100
    supply: number; // 0-100
    lastUpdated: Date;
  }[];
  riskMultiplier: number; // Law enforcement intensity
  events: { type: string; effect: number; expiresAt: Date }[];
}
```

### API Endpoints

| Method | Path | Purpose |
|--------|------|---------|
| GET | `/api/crime/inventory` | Get player inventory |
| POST | `/api/crime/inventory/buy` | Purchase drugs |
| POST | `/api/crime/inventory/sell` | Sell drugs |
| GET | `/api/crime/pricing` | Get all state prices |
| GET | `/api/crime/pricing/:state` | Get specific state prices |
| POST | `/api/crime/travel` | Travel to new state |
| GET | `/api/crime/pricing/history/:substance/:state` | Price history |

### Components

| Component | Purpose |
|-----------|---------|
| `TradingDashboard.tsx` | Main trading interface with buy/sell/travel |
| `InventoryPanel.tsx` | Player's current drug inventory |
| `PricingTable.tsx` | All states with current prices |
| `StateMap.tsx` | Interactive US map with price heat overlay |
| `TravelModal.tsx` | Select destination, see time/risk/cost |
| `BuyModal.tsx` | Purchase interface with quantity slider |
| `SellModal.tsx` | Sell interface with profit calculation |
| `PriceChart.tsx` | Historical price chart (7d, 30d, 90d) |
| `CrimeTutorial.tsx` | react-joyride wrapper for crime tour |

### Dependencies to Add

```json
{
  "react-joyride": "^2.9.3",
  "recharts": "^2.x" // for price charts (already exists?)
}
```

## Implementation Phases

### Phase 1: Player Inventory System (4h)
- PlayerInventory model
- Inventory API endpoints
- InventoryPanel component
- Basic buy/sell mutations

### Phase 2: State Pricing Engine (4h)  
- StatePricing model
- 50-state seed data
- Price fluctuation scheduler (every game tick)
- Pricing API endpoints

### Phase 3: Trading Interface (6h)
- TradingDashboard main component
- BuyModal with NPC inventory integration
- SellModal with profit/loss calculation
- Integration with existing Crime dashboard

### Phase 4: Travel & Map (4h)
- Travel API with time/cost/risk calculation
- TravelModal component
- StateMap with price heat visualization
- Update player location

### Phase 5: Tutorial System (4h)
- Install react-joyride
- CrimeTutorial component with step definitions
- Tutorial progress tracking (localStorage + DB)
- "Start Tour" button in Crime dashboard

### Phase 6: Polish & Events (2h)
- Price charts (recharts)
- Random events that affect prices
- UI polish and animations

## Dependencies
- Existing crime system (ProductionFacility, MarketplaceListing)
- Game time system for price ticks
- User session for inventory ownership

## Files

| Action | Path | Description |
|--------|------|-------------|
| NEW | `src/lib/db/models/crime/PlayerInventory.ts` | Player drug inventory |
| NEW | `src/lib/db/models/crime/StatePricing.ts` | 50-state pricing data |
| NEW | `src/app/api/crime/inventory/route.ts` | Inventory CRUD |
| NEW | `src/app/api/crime/inventory/buy/route.ts` | Purchase endpoint |
| NEW | `src/app/api/crime/inventory/sell/route.ts` | Sell endpoint |
| NEW | `src/app/api/crime/pricing/route.ts` | Get all prices |
| NEW | `src/app/api/crime/pricing/[state]/route.ts` | State prices |
| NEW | `src/app/api/crime/travel/route.ts` | Travel between states |
| NEW | `src/components/crime/trading/TradingDashboard.tsx` | Main trading UI |
| NEW | `src/components/crime/trading/InventoryPanel.tsx` | Player inventory |
| NEW | `src/components/crime/trading/PricingTable.tsx` | All state prices |
| NEW | `src/components/crime/trading/StateMap.tsx` | Interactive map |
| NEW | `src/components/crime/trading/BuyModal.tsx` | Buy interface |
| NEW | `src/components/crime/trading/SellModal.tsx` | Sell interface |
| NEW | `src/components/crime/trading/TravelModal.tsx` | Travel interface |
| NEW | `src/components/crime/trading/PriceChart.tsx` | Price history |
| NEW | `src/components/crime/tutorial/CrimeTutorial.tsx` | Tutorial wrapper |
| NEW | `src/hooks/useTradingGame.ts` | Trading state management |
| NEW | `src/lib/validations/trading.ts` | Zod schemas |
| NEW | `src/lib/types/trading.ts` | TypeScript types |
| NEW | `scripts/loaders/statePricing.seed.ts` | 50-state seed data |
| MOD | `src/components/crime/CrimeDashboard.tsx` | Add Trading tab |
| MOD | `src/app/game/crime/page.tsx` | Integrate trading |
| MOD | `package.json` | Add react-joyride |

## Notes
- Price fluctuation should be tied to game ticks (not real-time)
- Consider adding "cops" events that can seize inventory
- Higher quantities in inventory = higher heat accumulation
- Consider "stash houses" for safer storage
- Bulk discounts for large purchases
- Reputation system affects prices (better rep = better prices)

## Substances Catalog (Initial)
| Substance | Base Price | Volatility | Legal Status |
|-----------|-----------|------------|--------------|
| Cannabis | $15/unit | Low | Varies by state |
| Cocaine | $100/unit | Medium | Illegal |
| Heroin | $80/unit | Medium | Illegal |
| Meth | $60/unit | High | Illegal |
| Ecstasy | $25/unit | Medium | Illegal |
| LSD | $10/unit | Low | Illegal |
| Fentanyl | $200/unit | Very High | Illegal |
| Prescription Opioids | $50/unit | Low | Controlled |

---
*Created by ECHO v1.4.0*
