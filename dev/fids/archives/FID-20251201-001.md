# FID-20251201-001 — Crime P1 Backlog: Business Integration, Conversion, and Safeguards

Prepared: 2025-12-01
Owner: Platform Architecture (ECHO v1.3.3)
Status: COMPLETED
Priority: P1 (High)
Complexity: 4/5
Estimate: 14–20 hours
Started: 2025-12-01
Completed: 2025-12-01
Dependencies: FID-20251127-CRIME (✅ Complete)
Scope: Finalize Crime domain by adding Business integration and production hardening (conversion audit trail, pagination, rate limiting, transactions, idempotency, versioning) and developer ergonomics (hooks, docs/tests).

---

## Summary
This FID delivers the remaining P1 backlog to complete the Crime domain for production readiness. It introduces a first-class Business entity for legalized conversions, wires the conversion flow end-to-end with auditability, and adds platform safeguards (pagination, rate limiting, transactional integrity, optimistic locking, idempotency) across critical operations.

---

## Acceptance Criteria
- Business model, types, and validations exist; compile cleanly and support conversion requirements.
- Business CRUD API routes implemented with Zod validation, `auth()` authorization, and consistent error format.
- Crime conversion endpoint creates a Business exactly once (idempotent), links facility↔business, transfers inventory/metadata, and marks facility status `CONVERTED`.
- ConversionHistory model + list endpoint persist conversion records with pre/post snapshots and filters.
- FacilityStatus enum includes `CONVERTED`; all references updated with TypeScript passing (0 errors baseline maintained).
- List endpoints (facilities, routes, marketplace, gangs, territories) support pagination with default 50 and max 200, returning `nextCursor`/`offset` as applicable.
- Write routes protected by rate limits (per-IP and per-user); exceedances return 429 with `Retry-After` or equivalent headers.
- Multi-step operations (conversion, laundering batch, turf-war resolution) wrapped in MongoDB transactions; failures roll back atomically.
- Optimistic locking in place for critical updates; concurrent modifications return 409.
- Idempotency keys supported for selected POST/PATCH routes; repeated requests with same key do not duplicate side effects.
- New `useBusiness` SWR hooks provided; existing crime hooks accept pagination params; all types strict.
- Documentation added under /docs; integration tests cover conversion flow and idempotency behavior; all tests pass locally.

---

## Implementation Approach (Utility-First)
1. Types → Validations → Model for Business and ConversionHistory.
2. Extend Crime enums/DTOs for `CONVERTED` status.
3. Implement Business API (list, create; by-id get/patch/delete) with Zod + `auth()` and unified error responses.
4. Wire conversion endpoint to create Business (idempotent), link, transfer, and record ConversionHistory in a transaction.
5. Platform safeguards: pagination (cursor/offset), basic rate-limiting util (dev), idempotency key storage, optimistic locking strategies.
6. SWR hooks for Business + pagination support on existing crime hooks.
7. Docs + tests: API examples, conversion E2E, idempotency checks.

---

## Files

### New
- `src/lib/db/models/business/Business.ts`
- `src/lib/types/business.ts`
- `src/lib/validations/business.ts`
- `src/lib/db/models/crime/ConversionHistory.ts`
- `src/app/api/business/route.ts`
- `src/app/api/business/[id]/route.ts`
- `src/hooks/useBusiness.ts`
- `src/lib/server/rateLimit.ts` (simple dev util)
- `src/lib/server/idempotency.ts` (key storage + check)

### Modified
- `src/app/api/crime/conversion/route.ts` (or equivalent conversion endpoint): create/link Business, transaction, idempotency, history
- `src/lib/types/crime.ts` (FacilityStatus add `CONVERTED`)
- `src/lib/validations/crime.ts` (enum updates if needed)
- `src/lib/dto/crime.ts` and/or adapters (status handling)
- Crime list endpoints for pagination: facilities, routes, marketplace, gangs, territories
- Crime hooks: add pagination params
- `/docs` new page(s) for Business + Conversion

---

## Risks & Mitigations
- Transaction support on current Mongo deployment → use Mongoose sessions; feature-detect and fallback with compensating logic in dev only.
- Idempotency storage persistence → start with Mongo collection + TTL index; document production alternatives (Redis/Upstash) in docs.
- Rate limiting accuracy in dev → in-memory soft limits with headers; document proxy/WAF production strategies.

---

## Definition of Done
- All Acceptance Criteria met.
- TypeScript strict mode: `npx tsc --noEmit` returns 0 errors.
- Linting/formatting clean (project standards).
- Docs present in `/docs` with API examples and conversion flow diagram.
- New and impacted endpoints verified manually (basic smoke) and with tests for conversion/idempotency.
- FID moved from planned → progress → completed with metrics.

---

## Tracking
This FID will be moved to `dev/progress.md` when implementation begins and to `dev/completed.md` upon completion, following ECHO Auto-Audit procedures.

---

## Completion Summary (2025-12-01)

Status: ✅ COMPLETED (P1 Backlog delivered)

Deliverables:
- Business model/types/validations; CRUD API (list/create, get/patch/delete)
- Transactional conversion endpoint: idempotent creation, facility↔business link, history write
- ConversionHistory model + list endpoint
- FacilityStatus extended with CONVERTED (types/DTOs/models updated)
- Pagination on facilities/routes/marketplace GET endpoints (with meta)
- In-memory rate limiting util with standard headers (X-RateLimit-*, Retry-After)
- Optimistic locking on critical updates with 409 precondition handling; ETag/If-Unmodified-Since patterns
- Persistent idempotency keys with replay-safe helper
- Business SWR hooks (list/detail/mutations)
- Documentation under `docs/SAFEGUARDS_CRIME_BUSINESS_20251201.md`

Verification:
- Tests: Full suite green (post politics endpoint fixes)
- TypeScript: `npx tsc --noEmit` → 0 errors

Notes:
- Production-grade persistence for rate limiting can be swapped for Redis/Upstash; documented in safeguards
- Idempotency key TTL/replay behavior validated in tests
