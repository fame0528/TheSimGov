# FID-20251121-002: State Perk Registration System

**Status:** ✅ COMPLETED  
**Priority:** HIGH  
**Complexity:** 4/5  
**Created:** 2025-11-21  
**Started:** 2025-11-21  
**Completed:** 2025-11-21  
**Estimated:** 6-8 hours  
**Actual:** 6 hours 30 minutes

---

## Summary

Complete state perk system enabling players to choose home state at registration. State choice provides balanced economic advantages based on real-world data (tax burden, unemployment rate, GDP per capita). Includes data migration from legacy codebase, User model enhancement with firstName/lastName/state fields, registration UI with interactive state selection, and comprehensive perk display panel. Creates strategic depth through permanent state choice while maintaining competitive balance (no objectively "best" state).

---

## Acceptance Criteria

### User Model
- ✅ Add `firstName` field (string, required, 1-50 chars, trimmed)
- ✅ Add `lastName` field (string, required, 1-50 chars, trimmed)
- ✅ Add `state` field (string, required, 2-char uppercase, validated against 51 states)
- ✅ Zod validation schema updates for all new fields
- ✅ State validation ensures value exists in STATE_ABBREVIATIONS constant

### State Data
- ✅ Port legacy state data (name, abbreviation, GDP, population, crime, seats)
- ✅ Add new economic fields (taxBurden, unemploymentRate, hasStateIncomeTax, salesTaxRate)
- ✅ Add calculated perk fields (profitMarginBonus, hiringDifficultyMultiplier, wageMultiplier, industryBonuses)
- ✅ Store as TypeScript constants (not database) for zero latency and type safety
- ✅ Complete JSDoc documentation for all perk calculations

### Registration UI
- ✅ Enhanced registration form with firstName, lastName, state fields
- ✅ StateSelector component (searchable dropdown, 51 states alphabetical, keyboard accessible)
- ✅ StatePerkPanel component (displays population, GDP, tax, unemployment, perks)
- ✅ Color-coded advantages (green) vs disadvantages (red)
- ✅ Responsive design (mobile + desktop)
- ✅ Accessibility compliance (keyboard navigation, screen reader support)

### Quality
- ✅ TypeScript strict mode: 0 errors
- ✅ Complete JSDoc documentation for all new code
- ✅ Production-ready error handling
- ✅ Comprehensive inline comments

---

## Implementation Approach

### Phase 1: Data Migration & Type Definitions (2h)

**Objectives:**
- Port 51 states from legacy codebase with complete data
- Add new economic perk fields from Wikipedia research
- Calculate gameplay perk values
- Create TypeScript constants for type safety and performance

**Steps:**
1. Create `src/lib/types/state.ts`:
   - Define `StatePerkData` interface with all fields
   - Legacy fields: name, abbreviation, gdpMillions, gdpPerCapita, population, violentCrimeRate, senateSeatCount, houseSeatCount
   - New fields: taxBurden, unemploymentRate, hasStateIncomeTax, salesTaxRate
   - Calculated fields: profitMarginBonus, hiringDifficultyMultiplier, wageMultiplier, industryBonuses
   - Helper types: StateAbbreviation union type

2. Create `src/lib/data/states.ts`:
   - Port base data from `old projects/politics/src/lib/seed/states-part*.ts`
   - Add economic data from Wikipedia research (tax, unemployment)
   - Calculate perk bonuses using formulas:
     - Tax: No income tax = +15%, Low (<$3.5k) = +10%, High (>$6k) = -10%
     - Labor: Tight (<2.5%) = +quality/-speed, Slack (>4.5%) = +speed/-productivity
     - GDP: High (>$90k) = tech/finance bonuses, Low (<$70k) = manufacturing/ag bonuses
     - Sales tax: None = +10% retail, High (>8%) = -10% retail
     - Industry specializations per state
   - Export as `const STATES: readonly StatePerkData[]` for immutability

3. Create `src/lib/utils/stateHelpers.ts`:
   - `getStateByAbbr(abbreviation: string): StatePerkData | undefined`
   - `getStateByName(name: string): StatePerkData | undefined`
   - `getAllStates(): readonly StatePerkData[]`
   - `STATE_ABBREVIATIONS: readonly string[]` for validation
   - Complete JSDoc with usage examples

**Files:**
- [NEW] `src/lib/types/state.ts` (~200 lines)
- [NEW] `src/lib/data/states.ts` (~1,800 lines - 51 states × ~35 lines each)
- [NEW] `src/lib/utils/stateHelpers.ts` (~100 lines)

---

### Phase 2: User Model Enhancement (1h)

**Objectives:**
- Add firstName, lastName, state to User model
- Update TypeScript interface
- Add validation with Zod
- Ensure state validated against 51-state list

**Steps:**
1. Update `src/lib/types/models.ts`:
   - Add `firstName: string` to User interface
   - Add `lastName: string` to User interface
   - Add `state: string` to User interface (2-char abbreviation)
   - Complete JSDoc for new fields

2. Update `src/lib/db/models/User.ts`:
   - Add firstName field (required, 1-50 chars, trimmed)
   - Add lastName field (required, 1-50 chars, trimmed)
   - Add state field (required, 2 chars, uppercase)
   - Add pre-save validation for state (must exist in STATE_ABBREVIATIONS)

3. Create validation schemas:
   - Update existing auth validation with firstName/lastName/state
   - State validator using STATE_ABBREVIATIONS constant
   - Proper error messages for validation failures

**Files:**
- [MOD] `src/lib/types/models.ts` (~30 lines added)
- [MOD] `src/lib/db/models/User.ts` (~40 lines added)

---

### Phase 3: Registration UI Enhancement (3h)

**Objectives:**
- Add firstName, lastName, state to registration form
- Create StateSelector component (searchable dropdown)
- Create StatePerkPanel component (info display)
- Integrate with existing form validation
- Ensure responsive and accessible

**Steps:**
1. Read `src/app/(auth)/register/page.tsx` completely (line 1 to EOF)
   - Understand existing form structure
   - Identify form state management approach
   - Locate validation logic
   - Understand submission flow

2. Create `src/components/auth/StateSelector.tsx`:
   - Searchable dropdown using HeroUI Select component
   - Display all 51 states alphabetically
   - Show abbreviation + full name (e.g., "CA - California")
   - Keyboard accessible (arrow keys, type to search)
   - Clear visual selection state
   - Props: `value: string`, `onChange: (state: string) => void`, `error?: string`

3. Create `src/components/auth/StatePerkPanel.tsx`:
   - Info panel showing state advantages
   - Display when state selected (null state = hidden)
   - Show: Population, GDP per capita, tax burden, unemployment rate
   - Show perk bonuses with color coding:
     - Green text for advantages (+X%)
     - Red text for disadvantages (-X%)
   - Industry specializations listed
   - Responsive card layout using HeroUI Card
   - Props: `stateAbbr: string | null`

4. Update `src/app/(auth)/register/page.tsx`:
   - Add firstName field (HeroUI Input, required, 1-50 chars)
   - Add lastName field (HeroUI Input, required, 1-50 chars)
   - Add state field using StateSelector component
   - Add StatePerkPanel conditionally rendered when state selected
   - Update form state to include firstName, lastName, state
   - Update validation to include new fields
   - Update form submission to include new fields
   - Maintain existing email/password/confirmPassword logic

**Files:**
- [NEW] `src/components/auth/StateSelector.tsx` (~150 lines)
- [NEW] `src/components/auth/StatePerkPanel.tsx` (~200 lines)
- [MOD] `src/app/(auth)/register/page.tsx` (~100 lines added)

---

### Phase 4: Testing & Validation (1h)

**Objectives:**
- Verify TypeScript compilation
- Test form validation
- Test state selection UI
- Verify user registration with new fields
- Test responsive design
- Test accessibility

**Steps:**
1. TypeScript verification:
   - Run `npm run type-check`
   - Verify 0 errors with strict mode
   - Check all new files compile cleanly

2. Form validation testing:
   - Test all fields required
   - Test firstName/lastName min/max length
   - Test state must be valid 2-char abbreviation
   - Test password confirmation works
   - Test email format validation
   - Test form submission with valid data

3. UI functionality testing:
   - Test StateSelector displays all 51 states
   - Test search/filter functionality works
   - Test StatePerkPanel shows correct data per state
   - Test panel shows/hides based on selection
   - Test perk values color-coded correctly

4. Integration testing:
   - Test user registration succeeds with new fields
   - Test user data saved to database correctly
   - Verify firstName, lastName, state in created user document
   - Test no console errors or warnings

5. Responsive design testing:
   - Test mobile viewport (320px, 375px)
   - Test tablet viewport (768px)
   - Test desktop viewport (1024px+)
   - Verify form usable on all sizes

6. Accessibility testing:
   - Test keyboard navigation (tab through all fields)
   - Test form submission with Enter key
   - Test screen reader compatibility (aria-labels present)
   - Test error messages announced properly

---

## State Perk Design Philosophy

### Balance Principles
1. **No Objectively Best State**: Every state has tradeoffs
2. **Real Economic Data**: Tax burden and unemployment from Wikipedia 2023-2024
3. **Strategic Depth**: Permanent choice creates meaningful commitment
4. **Educational Value**: Players learn real economic differences between states

### Perk Categories

**Tax Environment:**
- No state income tax: +15% profit margin (AK, FL, NV, NH, SD, TN, TX, WA, WY)
- Low tax burden (<$3,500): +10% profit margin
- High tax burden (>$6,000): -10% profit margin BUT +education/infrastructure bonuses

**Labor Market:**
- Tight market (<2.5% unemployment): +quality workers, -hiring speed
- Slack market (>4.5% unemployment): +hiring speed, -productivity

**Economic Strength:**
- High GDP (>$90k per capita): Tech/finance bonuses, better capital access
- Low GDP (<$70k per capita): Manufacturing/agriculture bonuses, lower costs

**Sales Tax:**
- No sales tax: +10% retail revenue (AK, DE, MT, NH, OR)
- High sales tax (>8%): -10% retail revenue

**Industry Specializations (State-Specific):**
- California: +30% tech sector
- Texas: +30% energy sector
- New York: +30% finance sector
- Florida: +25% tourism sector
- Illinois: +25% logistics/distribution
- Washington: +30% tech sector
- Massachusetts: +25% biotech sector
- And 44 more state-specific bonuses...

---

## Dependencies

**Required (All Completed):**
- ✅ FID-20251120-001 (Infrastructure-First Foundation)
  - Utility infrastructure available
  - TypeScript types system
  - Component patterns established

**Blocks:**
- Future game mechanics that use state perks (profit calculations, hiring, etc.)

---

## Files Modified/Created

**NEW Files (5):**
1. `src/lib/types/state.ts` - StatePerkData interface (~200 lines)
2. `src/lib/data/states.ts` - 51 states complete data (~1,800 lines)
3. `src/lib/utils/stateHelpers.ts` - Helper functions (~100 lines)
4. `src/components/auth/StateSelector.tsx` - State dropdown (~150 lines)
5. `src/components/auth/StatePerkPanel.tsx` - Perk display (~200 lines)

**MODIFIED Files (3):**
1. `src/lib/types/models.ts` - User interface update (~30 lines added)
2. `src/lib/db/models/User.ts` - Schema update (~40 lines added)
3. `src/app/(auth)/register/page.tsx` - Form enhancement (~100 lines added)

**Total:** 8 files, ~2,620 lines of code

---

## Risk Assessment

**Low Risk:**
- Pure additive changes (no breaking changes to existing code)
- State data isolated in own module
- User model changes backward compatible (new optional fields initially)
- UI changes isolated to registration flow

**Mitigation:**
- Complete file reading before modifications (ECHO compliance)
- TypeScript strict mode catches type issues
- Comprehensive testing phase
- Production-ready error handling

---

## Success Metrics

**Implementation:**
- TypeScript compilation: 0 errors
- All 51 states with complete perk data
- Registration form functional with new fields
- State selection updates perk panel in real-time

**Quality:**
- Complete JSDoc documentation
- Comprehensive inline comments
- AAA-quality code standards
- Accessibility compliance

**User Experience:**
- Intuitive state selection interface
- Clear perk advantage communication
- Responsive on all devices
- Educational (learn real state economics)

---

**ECHO v1.1.0 - FID Created 2025-11-21**
