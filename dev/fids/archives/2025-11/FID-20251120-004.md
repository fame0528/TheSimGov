# FID-20251120-004: Contract System - Revenue Engine

**Status:** COMPLETED ✅  
**Priority:** CRITICAL  
**Complexity:** 4/5  
**Created:** 2025-11-20  
**Started:** 2025-11-20 11:25  
**Completed:** 2025-11-20 13:40  
**Estimated Time:** 3-4 hours  
**Actual Time:** 2h 15m  
**Completion Report:** [docs/COMPLETION_REPORT_FID-20251120-004_20251120.md](../../docs/COMPLETION_REPORT_FID-20251120-004_20251120.md)

---

## Summary

Complete contract management system providing revenue generation for companies. NPC client marketplace, bid/accept workflow, employee assignment based on skills, success calculation, and payment upon completion. Enables sustainable company operations by providing income to offset employee salaries.

**COMPLETED:** 2025-11-20 13:40 with 100% acceptance criteria met, 0 TypeScript errors, 25% faster than estimate.

---

## Business Problem

Companies currently have employees costing salary but no revenue source. Without contracts, companies go bankrupt immediately. Contract system provides the core revenue engine that makes the business simulation viable.

---

## Acceptance Criteria

- [ ] Contract Mongoose model with client, value, duration, requirements, status
- [ ] Type definitions: Contract, ContractClient, ContractRequirements, ContractStatus
- [ ] Constants for contract tiers, difficulty scaling, success formulas
- [ ] GET /api/contracts/marketplace - NPC contract generation (scaled to company level)
- [ ] GET /api/contracts - List company's contracts (active, completed, failed)
- [ ] POST /api/contracts/[id]/bid - Submit bid with timeline/cost estimates
- [ ] POST /api/contracts/[id]/accept - Accept contract (deduct upfront cost)
- [ ] POST /api/contracts/[id]/assign - Assign employees to contract
- [ ] POST /api/contracts/[id]/complete - Mark complete, calculate payout
- [ ] Contract marketplace UI with filters (industry, difficulty, value)
- [ ] Contract detail page (requirements, client info, bid form)
- [ ] Active contracts dashboard (progress, assigned employees)
- [ ] Contract execution page (employee assignment, progress tracking)
- [ ] ContractCard component (reusable summary card)
- [ ] TypeScript strict mode: 0 errors
- [ ] Complete JSDoc documentation
- [ ] Production-ready (no placeholders)

---

## Implementation Approach

### Phase 1: Database Foundation (45-60m)
- Contract model with client, value, duration, requirements, status
- Type definitions for Contract, ContractClient, ContractRequirements
- Constants for tiers, difficulty scaling, success formulas
- Virtuals: isExpired, daysRemaining, estimatedPayout
- Methods: calculateSuccess, calculatePayout, assignEmployees, complete

### Phase 2: API Routes (60-90m)
- POST/GET /api/contracts/marketplace (NPC generation)
- POST /api/contracts/[id]/bid (submit bid, deduct upfront)
- POST /api/contracts/[id]/accept (accept winning bid)
- POST /api/contracts/[id]/assign (assign employees, validate skills)
- POST /api/contracts/[id]/complete (calculate success, payout)
- GET /api/contracts (list company contracts)

### Phase 3: UI Components (60-90m)
- Contract marketplace page (grid, filters, sort)
- Contract detail page (requirements, bid form, skills match)
- Active contracts dashboard (list, progress, assignments)
- Contract execution page (employee assignment UI)
- ContractCard component (reusable summary)

---

## Files to Create

**Database:**
1. `src/lib/db/models/Contract.ts` (~400 lines)
2. `src/lib/types/models.ts` (add Contract interfaces)
3. `src/lib/utils/constants.ts` (expand CONTRACT_PARAMETERS)

**API Routes:**
4. `src/app/api/contracts/marketplace/route.ts` (~250 lines)
5. `src/app/api/contracts/route.ts` (~180 lines)
6. `src/app/api/contracts/[id]/bid/route.ts` (~180 lines)
7. `src/app/api/contracts/[id]/accept/route.ts` (~150 lines)
8. `src/app/api/contracts/[id]/assign/route.ts` (~200 lines)
9. `src/app/api/contracts/[id]/complete/route.ts` (~220 lines)

**UI Components:**
10. `src/app/(game)/contracts/marketplace/page.tsx` (~320 lines)
11. `src/app/(game)/contracts/[id]/page.tsx` (~380 lines)
12. `src/app/(game)/contracts/active/page.tsx` (~290 lines)
13. `src/app/(game)/contracts/[id]/execute/page.tsx` (~350 lines)
14. `src/lib/components/contract/ContractCard.tsx` (~180 lines)
15. `src/lib/components/contract/index.ts` (~10 lines)

**Hooks:**
16. `src/lib/hooks/useContract.ts` (~120 lines)

**Endpoints:**
17. `src/lib/api/endpoints.ts` (add contractEndpoints)

**Total:** 17 files, ~3,400 lines

---

## Dependencies

- ✅ FID-001 (Infrastructure) - useContract hooks, endpoints, types
- ✅ FID-002 (Company System) - Company cash, level, industry
- ✅ FID-003 (Employee System) - Employee skills for contract execution

---

## Contract Tiers

| Tier | Level | Value Range | Duration | Skill Req | Count |
|------|-------|-------------|----------|-----------|-------|
| 1    | 1-2   | $1k-$10k    | 1-7d     | 30-50 avg | 15    |
| 2    | 2-3   | $10k-$50k   | 7-30d    | 40-60 avg | 12    |
| 3    | 3-4   | $50k-$250k  | 30-90d   | 50-70 avg | 10    |
| 4    | 4-5   | $250k-$1M   | 90-180d  | 60-80 avg | 7     |
| 5    | 5     | $1M-$5M     | 180-365d | 70-90 avg | 5     |

---

## Success Formula

- Success Score = Average(Employee Skills) vs Requirements
- Success >= 90: Base + 10% bonus
- Success >= 75: Base value
- Success >= 60: Base - 5% penalty
- Success < 60: Base - 15% penalty
- Late delivery: Additional -15% penalty

---

## Notes

This is the critical revenue engine. Without it, companies cannot sustain employee salaries and go bankrupt. Contracts provide income that enables the core business simulation loop: hire employees → execute contracts → earn revenue → hire more employees → take bigger contracts.
