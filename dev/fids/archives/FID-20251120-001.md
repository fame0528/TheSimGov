# FID-20251120-001: Infrastructure-First Foundation

**Created:** 2025-11-20  
**Status:** COMPLETED  
**Completed:** 2025-11-20  
**Priority:** CRITICAL  
**Complexity:** 4/5  
**Estimated Time:** 14-18h

---

## üìã Summary

Build complete utility infrastructure from day 1 to prevent the systemic ECHO violation that plagued the legacy build (~10,181 lines of duplication). Create centralized API client, shared React hooks, utility functions, TypeScript types, reusable UI components, layouts, contexts, and UI-specific hooks BEFORE implementing any business features. **DRY principle enforced across entire application** - backend, frontend, utilities, types, validation, UI components, state management.

**Strategic Value:** Enables 70-82% code reduction across entire project lifecycle by eliminating duplication at every layer.

---

## ‚úÖ Acceptance Criteria

- [ ] Next.js 15 project initialized with TypeScript strict mode, App Router, Tailwind CSS
- [ ] Core dependencies installed (MongoDB, NextAuth v5, Chakra UI, Zod, currency.js, faker, uuid)
- [ ] lib/api/ directory with apiClient.ts, errors.ts, endpoints.ts (~200 lines)
- [ ] lib/hooks/ directory with 7 data hooks (~420 lines)
- [ ] lib/hooks/ui/ directory with 5 UI hooks (~250 lines)
- [ ] lib/utils/ directory with 5 utility modules (~300 lines)
- [ ] lib/types/ directory with 4 type definition files (~200 lines)
- [ ] lib/components/shared/ directory with 7 reusable components (~450 lines)
- [ ] lib/components/layouts/ directory with 3 layout components (~250 lines)
- [ ] lib/contexts/ directory with 3 context providers (~300 lines)
- [ ] MongoDB connection with pooling and error handling
- [ ] NextAuth.js v5 configuration with credentials provider
- [ ] Test page demonstrating all infrastructure (API, hooks, components, contexts)
- [ ] TypeScript strict mode passing (0 errors)
- [ ] Zero duplicate components across codebase
- [ ] Documentation: INFRASTRUCTURE.md with usage examples for all layers

---

## üèóÔ∏è Implementation Approach

### **Phase 0: Project Initialization (1-2h)**

**Tasks:**
1. Initialize Next.js 15 with TypeScript, App Router, Tailwind CSS
2. Install all dependencies (see Dependencies section)
3. Configure TypeScript strict mode
4. Setup folder structure (src/lib/, app/api/, etc.)
5. Configure .env.local with MongoDB URI

**Commands:**
```bash
npx create-next-app@latest politics_game --typescript --tailwind --app
cd politics_game

# Core dependencies
npm install mongodb mongoose next-auth@beta bcryptjs

# UI & Styling
npm install @chakra-ui/react @chakra-ui/next-js @chakra-ui/icons
npm install @emotion/react @emotion/styled framer-motion
npm install react-icons @fortawesome/fontawesome-free

# Utilities & Validation
npm install zod currency.js @faker-js/faker uuid dayjs
npm install chance mathjs winston dotenv

# Real-time & State
npm install socket.io socket.io-client swr zustand

# Additional UI Libraries
npm install react-toastify recharts rc-slider
npm install @tippyjs/react tippy.js react-simple-maps

# Dev Dependencies
npm install -D @types/bcryptjs @types/node @types/react @types/react-dom
npm install -D @typescript-eslint/eslint-plugin @typescript-eslint/parser
npm install -D jest @testing-library/react @testing-library/jest-dom
npm install -D @playwright/test mongodb-memory-server
npm install -D babel-jest @babel/preset-env @babel/preset-react @babel/preset-typescript
```

---

### **Phase 1: API Infrastructure (2-3h)**

**lib/api/apiClient.ts (~80 lines):**
- ApiClient class with request(), get(), post(), patch(), delete()
- Centralized auth header injection
- Standardized error handling
- Type-safe response parsing
- **PREVENTS:** 257 duplicate fetch wrappers in legacy build

**lib/api/errors.ts (~40 lines):**
- ApiError class extending Error
- Static factory methods (unauthorized, notFound, badRequest, serverError)
- Response status code mapping
- **PREVENTS:** 257 duplicate try-catch patterns

**lib/api/endpoints.ts (~80 lines):**
- Typed endpoint definitions as const object
- Endpoints for: auth, companies, employees, contracts, banking
- Dynamic path generation functions
- **PREVENTS:** Magic strings scattered across 111 components

**Total:** ~200 lines, 3 files

---

### **Phase 2: React Hooks Infrastructure (2-3h)**

**lib/hooks/useAPI.ts (~100 lines):**
- Generic data fetching hook
- Loading, error, data state management
- Auto-refetch on dependency change
- Optional polling support
- **PREVENTS:** 81 duplicate useEffect fetch patterns

**lib/hooks/useMutation.ts (~80 lines):**
- Generic mutation hook for POST/PATCH/DELETE
- Loading, error, data state management
- Reset function for form clearing
- **PREVENTS:** Duplicate loading/error state in 111 components

**lib/hooks/useCompany.ts (~60 lines):**
- Company data fetching
- Create company mutation
- List user's companies
- **PREVENTS:** 257 duplicate company lookup patterns

**lib/hooks/useAuth.ts (~50 lines):**
- Session state management
- Login/logout mutations
- User data fetching

**lib/hooks/useEmployee.ts (~50 lines):**
- Employee CRUD operations
- Hire, fire, train mutations
- Employee list fetching

**lib/hooks/useContract.ts (~50 lines):**
- Contract marketplace fetching
- Bid submission
- Active contracts list

**lib/hooks/useBanking.ts (~30 lines):**
- Loan application
- Credit score fetching
- Bank list fetching

**Total:** ~420 lines, 7 files

---

### **Phase 3: Utility Functions (1-2h)**

**lib/utils/currency.ts (~60 lines):**
- formatCurrency(amount, decimals)
- calculatePercentage(value, total)
- calculateProfit(revenue, expenses)
- calculateMargin(revenue, expenses)
- abbreviateNumber(num) - K/M/B formatting
- **PREVENTS:** Duplicate formatting in 100+ components

**lib/utils/date.ts (~50 lines):**
- realHoursToGameWeeks(hours)
- realHoursToGameMonths(hours)
- realHoursToGameYears(hours)
- formatGameDate(realDate)
- calculateElectionCycle(startDate)
- TIME_MULTIPLIER constant (168x)

**lib/utils/validation.ts (~60 lines):**
- Zod schemas for: company creation, employee hire, loan application
- Reusable validation functions
- Error message formatting

**lib/utils/constants.ts (~80 lines):**
- COMPANY_LEVELS (L1-L5 configs)
- INDUSTRY_COSTS (startup costs)
- CREDIT_SCORE_FACTORS (FICO weights)
- TIME_MULTIPLIER
- All game constants centralized

**lib/utils/formatting.ts (~50 lines):**
- Number formatting helpers
- String truncation
- Date formatting

**Total:** ~300 lines, 5 files

---

### **Phase 4: TypeScript Types (1h)**

**lib/types/api.ts (~50 lines):**
- ApiResponse<T>
- ApiError
- PaginatedResponse<T>
- Generic API response types

**lib/types/models.ts (~80 lines):**
- User interface
- Company interface
- Employee interface
- Contract interface
- Loan interface
- All Mongoose model type definitions

**lib/types/enums.ts (~40 lines):**
- IndustryType enum
- LoanType enum
- ContractType enum
- All shared enums

**lib/types/game.ts (~30 lines):**
- CompanyLevel type (1-5)
- LevelConfig interface
- GameTime interface
- Game-specific types

**Total:** ~200 lines, 4 files

---

### **Phase 5: Database & Auth Setup (1-2h)**

**lib/db/mongoose.ts (~60 lines):**
- MongoDB connection with caching
- Connection pooling
- Error handling
- Environment variable validation

**auth.ts (~80 lines):**
- NextAuth.js v5 configuration
- Credentials provider with bcrypt
- Session strategy (JWT or database)
- Callbacks for session/JWT customization

**Total:** ~140 lines, 2 files

---

### **Phase 6: Verification & Documentation (1h)**

**app/api/test/route.ts (~40 lines):**
- Test endpoint demonstrating infrastructure usage
- Uses apiClient for consistency
- Zod validation
- Error handling
- Returns typed response

**docs/INFRASTRUCTURE.md (~300 lines):**
- Overview of all infrastructure
- Usage examples for each utility
- Best practices
- Common patterns
- Troubleshooting guide

**Total:** ~340 lines, 2 files

---

### **Phase 7: Shared UI Components (2-3h)**

**lib/components/shared/LoadingSpinner.tsx (~50 lines):**
- Reusable loading indicator (Chakra Spinner wrapper)
- Size variants (sm, md, lg)
- Custom colors
- Overlay mode
- **PREVENTS:** 50+ inline Spinner components

**lib/components/shared/ErrorMessage.tsx (~60 lines):**
- Standardized error display
- Dismissible alerts
- Error retry button
- Icon + message layout
- **PREVENTS:** Duplicate error UI in 111 components

**lib/components/shared/ConfirmDialog.tsx (~80 lines):**
- Reusable confirmation modal
- Customizable title/message/actions
- Async action support
- Loading state during confirmation
- **PREVENTS:** Duplicate modal logic in 30+ features

**lib/components/shared/DataTable.tsx (~120 lines):**
- Generic table component with TypeScript generics
- Column sorting
- Pagination controls
- Loading/empty states
- Row selection support
- **PREVENTS:** Duplicate table implementations

**lib/components/shared/FormField.tsx (~60 lines):**
- Standardized form input wrapper
- Label, error message, helper text
- Required indicator
- Disabled state
- Integrates with Zod validation
- **PREVENTS:** Duplicate form styling

**lib/components/shared/Card.tsx (~40 lines):**
- Consistent card container
- Header, body, footer sections
- Shadow/border variants
- **PREVENTS:** Inline Box/Flex patterns

**lib/components/shared/EmptyState.tsx (~40 lines):**
- "No data" placeholder
- Icon, title, description, action button
- Customizable messaging
- **PREVENTS:** Duplicate empty states

**Total:** ~450 lines, 7 files

---

### **Phase 8: Layouts & Contexts (2-3h)**

**lib/components/layouts/DashboardLayout.tsx (~100 lines):**
- Sidebar navigation
- Top bar with user menu
- Main content area
- Responsive breakpoints
- **PREVENTS:** Layout duplication across 20+ pages

**lib/components/layouts/AuthLayout.tsx (~80 lines):**
- Centered auth form layout
- Background styling
- Logo/branding
- **PREVENTS:** Login/register page duplication

**lib/components/layouts/PageHeader.tsx (~70 lines):**
- Page title, breadcrumbs, actions
- Back button support
- Consistent spacing
- **PREVENTS:** Header duplication

**lib/contexts/CompanyProvider.tsx (~120 lines):**
- Global company state (current company, list of companies)
- useCompanyContext hook
- Company switching logic
- **PREVENTS:** Prop drilling company data

**lib/contexts/AuthProvider.tsx (~100 lines):**
- Global auth state (user, session)
- useAuthContext hook
- Login/logout actions
- **PREVENTS:** Prop drilling user data

**lib/contexts/ThemeProvider.tsx (~80 lines):**
- Dark/light mode toggle
- useTheme hook
- LocalStorage persistence
- **PREVENTS:** Theme duplication

**Total:** ~550 lines, 6 files

---

### **Phase 9: UI Hooks (1-2h)**

**lib/hooks/ui/useToast.ts (~50 lines):**
- Wrapper around Chakra toast
- Pre-configured success/error/info/warning toasts
- Consistent positioning and duration
- **PREVENTS:** Toast configuration duplication

**lib/hooks/ui/useModal.ts (~40 lines):**
- Modal open/close state
- onOpen, onClose, isOpen
- **PREVENTS:** useState for modals everywhere

**lib/hooks/ui/usePagination.ts (~60 lines):**
- Page, limit, total state
- nextPage, prevPage, setPage functions
- hasNextPage, hasPrevPage computed
- **PREVENTS:** Pagination logic duplication

**lib/hooks/ui/useSort.ts (~50 lines):**
- sortBy, sortOrder state
- toggleSort function
- **PREVENTS:** Sorting state duplication

**lib/hooks/ui/useDebounce.ts (~50 lines):**
- Debounced value hook
- Configurable delay
- **PREVENTS:** Duplicate debounce logic for search inputs

**Total:** ~250 lines, 5 files

---

## üìÅ Files to Create (40 files, ~2,950 lines total)

### lib/api/ (3 files, ~200 lines)
- apiClient.ts
- errors.ts
- endpoints.ts

### lib/hooks/ (7 files, ~420 lines)
- useAPI.ts
- useMutation.ts
- useCompany.ts
- useAuth.ts
- useEmployee.ts
- useContract.ts
- useBanking.ts

### lib/utils/ (5 files, ~300 lines)
- currency.ts
- date.ts
- validation.ts
- constants.ts
- formatting.ts

### lib/types/ (4 files, ~200 lines)
- api.ts
- models.ts
- enums.ts
- game.ts

### lib/components/shared/ (7 files, ~450 lines)
- LoadingSpinner.tsx
- ErrorMessage.tsx
- ConfirmDialog.tsx
- DataTable.tsx
- FormField.tsx
- Card.tsx
- EmptyState.tsx

### lib/components/layouts/ (3 files, ~250 lines)
- DashboardLayout.tsx
- AuthLayout.tsx
- PageHeader.tsx

### lib/contexts/ (3 files, ~300 lines)
- CompanyProvider.tsx
- AuthProvider.tsx
- ThemeProvider.tsx

### lib/hooks/ui/ (5 files, ~250 lines)
- useToast.ts
- useModal.ts
- usePagination.ts
- useSort.ts
- useDebounce.ts

### lib/db/ (1 file, ~60 lines)
- mongoose.ts

### Root (1 file, ~80 lines)
- auth.ts

### app/api/ (1 file, ~40 lines)
- test/route.ts

### app/ (1 file, ~100 lines)
- test-infrastructure/page.tsx (demonstrates all infrastructure)

### docs/ (1 file, ~400 lines)
- INFRASTRUCTURE.md

---

## üîó Dependencies

### Core Framework
- next@^16.0.3 (latest)
- react@^18.3.1
- react-dom@^18.3.1
- typescript@^5.4.5

### Database & Auth
- mongodb
- mongoose@^8.4.0
- next-auth@^5.0.0-beta.19 (v5)
- bcryptjs@^2.4.3
- @types/bcryptjs

### UI & Styling
- @chakra-ui/react@^2.8.2
- @chakra-ui/next-js@^2.2.0
- @chakra-ui/icons@^2.1.1
- @emotion/react@^11.11.4
- @emotion/styled@^11.11.5
- framer-motion@^11.2.10
- tailwindcss@^3.4.0
- react-icons@^5.5.0
- @fortawesome/fontawesome-free@^6.5.1
- react-toastify@^11.0.5
- recharts@^3.4.1
- rc-slider@^11.1.9
- @tippyjs/react@^4.2.6
- tippy.js@^6.3.7
- react-simple-maps@^3.0.0

### Utilities & Validation
- zod@^3.23.8
- currency.js@^2.0.4
- @faker-js/faker@^10.1.0
- uuid@^13.0.0
- dayjs@^1.11.10
- chance@^1.1.13
- mathjs@^15.1.0
- winston@^3.11.0
- dotenv@^16.3.1

### State Management & Data Fetching
- swr@^2.2.5
- zustand@^4.5.2

### Real-time
- socket.io@^4.7.5
- socket.io-client@^4.7.5

### Testing & Dev Tools
- jest@^29.7.0
- @testing-library/react@^15.0.7
- @testing-library/jest-dom@^6.4.5
- @playwright/test@^1.44.1
- mongodb-memory-server@^8.16.1
- babel-jest@^29.7.0
- @babel/preset-env@^7.23.0
- @babel/preset-react@^7.28.5
- @babel/preset-typescript@^7.23.0
- @typescript-eslint/eslint-plugin@^7.13.0
- @typescript-eslint/parser@^7.13.0
- @types/node@^20.14.2
- @types/react@^18.3.3
- @types/react-dom@^18.3.0

---

## üìä Success Metrics

**TypeScript:**
- 0 errors in strict mode ‚úÖ
- 100% type coverage ‚úÖ

**Code Duplication:**
- 0% duplication (all patterns centralized at every layer) ‚úÖ
- Infrastructure reuse in ALL future features ‚úÖ
- Zero duplicate components across UI ‚úÖ
- Zero duplicate hooks across app ‚úÖ
- Zero duplicate layouts ‚úÖ

**Documentation:**
- Complete usage examples ‚úÖ
- All utilities documented ‚úÖ

**Verification:**
- Test route passes ‚úÖ
- All hooks work correctly ‚úÖ
- API client handles errors properly ‚úÖ

---

## üí° Lessons Applied from Legacy Build

### What Went Wrong (Legacy)
1. ‚ùå Features built BEFORE infrastructure
2. ‚ùå 257 API files duplicating auth/company/error (~7,196 lines)
3. ‚ùå 111 components duplicating fetch/loading/error (~2,985 lines)
4. ‚ùå 50+ inline Spinner components, 30+ duplicate modals
5. ‚ùå No shared layouts, contexts, or UI hooks
6. ‚ùå lib/api/ directory: 0 files
7. ‚ùå lib/hooks/: only 1 hook
8. ‚ùå lib/components/: 0 shared components

### What We're Doing Right (Clean Rebuild)
1. ‚úÖ Infrastructure FIRST across ALL layers, features SECOND
2. ‚úÖ Centralized API client (1 file, ~80 lines)
3. ‚úÖ Shared hooks library - data (7 hooks) + UI (5 hooks)
4. ‚úÖ Shared component library (7 components, ~450 lines)
5. ‚úÖ Consistent layouts (3 layouts, ~250 lines)
6. ‚úÖ Global state management (3 contexts, ~300 lines)
7. ‚úÖ Complete utility coverage from day 1
8. ‚úÖ TypeScript strict mode from start
9. ‚úÖ **DRY enforced at EVERY layer: backend, frontend, UI, state, validation**

### Proven Patterns to Use
1. ‚úÖ Enhanced Preflight Matrix (100% contract verification)
2. ‚úÖ Batch Loading Protocol (large file reading)
3. ‚úÖ Dual-Loading Protocol (backend + frontend)
4. ‚úÖ Real-time progress tracking
5. ‚úÖ AAA quality standards (JSDoc, no placeholders)

---

## üéØ Enables (Future Features)

**After infrastructure complete, enables:**

### Banking System (12h)
- Uses: lib/hooks/useBanking, lib/utils/constants (credit scoring)
- Uses: lib/api/apiClient for loan endpoints
- Uses: lib/types/models for Loan interface

### Company Levels (6h)
- Uses: lib/utils/constants (COMPANY_LEVELS)
- Uses: lib/types/game (CompanyLevel, LevelConfig)
- Uses: lib/hooks/useCompany for level progression

### Employee System (40-60h)
- Uses: lib/hooks/useEmployee for CRUD
- Uses: lib/api/endpoints for employee routes
- Uses: lib/types/models for Employee interface

### Industries (60-80h total)
- ALL industries use lib/api/apiClient
- ALL components use lib/hooks/useAPI, useMutation
- ZERO duplication across 6 industries

**Total Savings:** ~10,181 lines of duplication prevented

---

## üöÄ Next Steps After Completion

1. **Banking System** (FID-20251120-002)
   - NPC banks, FICO credit scoring, loan mechanics
   - Uses infrastructure: useBanking hook, constants
   - Estimated: 12h

2. **Company Levels** (FID-20251120-003)
   - L1-L5 progression with XP system
   - Uses infrastructure: constants, game types
   - Estimated: 6h

3. **Employee System** (FID-20251120-004)
   - 12 skills, 6 training types, retention mechanics
   - Uses infrastructure: useEmployee hook, validation schemas
   - Estimated: 40-60h

4. **Industries** (FID-20251120-005+)
   - 6 industries with ZERO duplication
   - ALL use infrastructure
   - Estimated: 60-80h total

**Grand Total:** 120-180h vs 650-870h legacy (66-79% reduction)

---

**Auto-maintained by ECHO v1.1.0**
