# FID-20251201-002 — ECHO Compliance Phase 1 (Envelopes + Type Safety)

Status: PLANNED
Priority: P1
Complexity: 3
Estimate: 4-6 hours
Created: 2025-12-01

## Summary
Normalize API response envelopes and tighten type safety at API boundaries for active `src/**` routes. This phase focuses on replacing direct `NextResponse.json(...)` with standardized helpers and removing `as any`/`as unknown as` casts in request parsing and DTO/adapters for selected high-traffic endpoints.

## Acceptance Criteria
- Standard envelopes: Migrated endpoints use `createSuccessResponse`/`createErrorResponse`; no direct `NextResponse.json(...)` in those files.
- Type safety: No `as any`/`as unknown as` within migrated endpoints’ handlers and their local DTO/adapters.
- Validation: Zod schemas retained or added; status codes and headers preserved.
- Build health: `npx tsc --noEmit` passes; existing tests remain green.
- Scope discipline: Legacy files under `old projects/**` excluded.

## Approach
1. Envelope migration for representative high-traffic endpoints (Phase 1 batch):
   - `src/app/api/manufacturing/facilities/route.ts`
   - `src/app/api/employees/[id]/route.ts`
   - `src/app/api/ai/marketplace/models/route.ts`
   - `src/app/api/politics/campaigns/route.ts`
2. Tighten API boundary types: Introduce minimal DTOs where missing; remove unsafe casts in parsing/mapping.
3. Preserve existing status codes, headers (ETag, pagination, rate-limit) and behavior.
4. Run TypeScript verification and tests; adjust as needed without broad refactors.

## Files (Initial Batch)
- MOD: `src/app/api/manufacturing/facilities/route.ts`
- MOD: `src/app/api/employees/[id]/route.ts`
- MOD: `src/app/api/ai/marketplace/models/route.ts`
- MOD: `src/app/api/politics/campaigns/route.ts`
- REF: `src/lib/utils/apiResponse.ts`

## Dependencies
- Envelope helpers: `src/lib/utils/apiResponse.ts`
- Existing Zod schemas within each route.

## Structured TODOs
1. Migrate envelopes in `manufacturing/facilities` route.
2. Remove unsafe casts and add DTOs where needed in `manufacturing/facilities`.
3. Migrate envelopes in `employees/[id]` route.
4. Remove unsafe casts and add DTOs where needed in `employees/[id]`.
5. Migrate envelopes in `ai/marketplace/models` route.
6. Remove unsafe casts and add DTOs where needed in `ai/marketplace/models`.
7. Migrate envelopes in `politics/campaigns` route.
8. Remove unsafe casts and add DTOs where needed in `politics/campaigns`.
9. Run TypeScript verification (`npx tsc --noEmit`).
10. Run tests; fix minor type/contract mismatches without changing behavior.

## Notes
- Exclude `old projects/**` from this phase.
- Keep response status codes and headers identical to current behavior.
