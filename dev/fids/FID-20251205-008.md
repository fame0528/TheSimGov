# FID-20251205-008: In-Game Email/Messaging System

**Status:** IN_PROGRESS
**Priority:** P2 (Medium)
**Complexity:** 4 (Complex)
**Estimated:** 12-16h
**Created:** 2025-12-05
**Started:** 2025-12-05

## Summary
AAA-quality player-to-player messaging system with rich text WYSIWYG editor. Players can send formatted messages, attach in-game items/currency, and manage conversations. Features Gmail-like UX with modern editor capabilities.

## Progress
- âœ… Created message types (MessageDTO, CreateMessageRequest, PaginatedResponse, etc.)
- âœ… Created Message mongoose model with indexes for efficient inbox/sent/thread queries
- âœ… Created API routes (GET /messages, POST /messages, GET/PATCH/DELETE /messages/[id], GET /messages/unread)
- âœ… Created useMessages SWR hook with optimistic updates
- âœ… Created TipTap MessageEditor component with formatting toolbar
- âœ… Created MessageList component with folder tabs
- âœ… Created MessageThread component for conversation view
- âœ… Created ComposeMessage modal component
- âœ… Created messages page at /game/messages
- âœ… Added Messages link to navigation
- âœ… TypeScript verification: 0 errors

## NPM Packages
| Package | Purpose | Why |
|---------|---------|-----|
| `@tiptap/react` | WYSIWYG Editor | Modern, extensible, React-native, great DX |
| `@tiptap/starter-kit` | Core extensions | Bold, italic, lists, headings, etc. |
| `@tiptap/extension-placeholder` | Placeholder text | UX polish |
| `@tiptap/extension-character-count` | Char limit | Enforce 5000 char limit |
| `@tiptap/extension-link` | Clickable links | Allow URLs in messages |
| `@tiptap/extension-mention` | @mentions | Tag other players |
| `@tiptap/extension-image` | Inline images | Embed images (optional) |
| `dompurify` | HTML sanitization | Prevent XSS attacks |
| `bad-words` | Profanity filter | Content moderation |

## Acceptance Criteria
- [ ] Rich text editor with formatting toolbar (bold, italic, underline, lists, links)
- [ ] @mention autocomplete for player usernames
- [ ] Character count with 5000 char limit
- [ ] Players can send messages to other players by username
- [ ] Recipient autocomplete search as you type
- [ ] Inbox displays received messages with sender, subject, timestamp, preview
- [ ] Sent folder shows outgoing messages
- [ ] Read/unread status tracking with visual indicators
- [ ] Message detail view renders formatted HTML safely
- [ ] Delete messages (soft delete, trash folder)
- [ ] Star/favorite important messages
- [ ] Unread count badge in navigation (real-time)
- [ ] Conversation threading (replies grouped)
- [ ] Attachments: Send in-game currency to players
- [ ] Profanity filter on message content
- [ ] Rate limiting (10 messages/minute)
- [ ] Mobile responsive design

## Implementation Approach

### Data Model
```typescript
interface Message {
  _id: ObjectId;
  
  // Participants
  senderId: ObjectId;
  senderUsername: string;      // Denormalized for display
  recipientId: ObjectId;
  recipientUsername: string;   // Denormalized for display
  
  // Content
  subject: string;             // Max 150 chars
  body: string;                // HTML content, max 5000 chars
  bodyPlainText: string;       // Stripped text for search/preview
  
  // Threading
  threadId: ObjectId;          // Groups conversation
  parentMessageId?: ObjectId;  // Reply to specific message
  
  // Attachments
  attachments: {
    type: 'currency' | 'item';
    amount?: number;           // For currency
    itemId?: ObjectId;         // For items
    claimed: boolean;
  }[];
  
  // Status flags (per-user)
  isRead: boolean;
  isStarred: boolean;
  isDeletedBySender: boolean;
  isDeletedByRecipient: boolean;
  
  // Timestamps
  createdAt: Date;
  readAt?: Date;
}

interface MessageThread {
  _id: ObjectId;
  participantIds: ObjectId[];
  lastMessageAt: Date;
  lastMessagePreview: string;
  messageCount: number;
}
```

### API Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/messages` | List inbox (paginated) |
| GET | `/api/messages/sent` | List sent messages |
| GET | `/api/messages/starred` | List starred messages |
| GET | `/api/messages/trash` | List deleted messages |
| GET | `/api/messages/threads` | List conversation threads |
| GET | `/api/messages/threads/[threadId]` | Get thread messages |
| GET | `/api/messages/[id]` | Get single message |
| POST | `/api/messages` | Send new message |
| POST | `/api/messages/[id]/reply` | Reply to message |
| PATCH | `/api/messages/[id]` | Update (read/star/delete) |
| PATCH | `/api/messages/bulk` | Bulk update (mark read, delete) |
| DELETE | `/api/messages/[id]` | Permanent delete |
| GET | `/api/messages/unread-count` | Get unread count |
| POST | `/api/messages/[id]/claim-attachment` | Claim currency/item |
| GET | `/api/users/search?q=` | Search users for recipient |

### UI Components
| Component | Purpose |
|-----------|---------|
| `MessageLayout` | Sidebar + content layout |
| `MessageSidebar` | Folders (Inbox, Sent, Starred, Trash) |
| `MessageList` | List of messages with virtual scroll |
| `MessageRow` | Single message preview row |
| `MessageDetail` | Full message view with actions |
| `MessageComposer` | New message modal with WYSIWYG |
| `RichTextEditor` | TipTap editor wrapper |
| `EditorToolbar` | Formatting buttons |
| `RecipientInput` | Autocomplete user search |
| `AttachmentPanel` | Send currency/items |
| `MentionList` | @mention autocomplete dropdown |
| `UnreadBadge` | Nav indicator with count |
| `ThreadView` | Conversation thread display |

### Editor Toolbar Features
```
[B] [I] [U] [S] | [H1] [H2] | [â€¢] [1.] | [Link] [ðŸ“Ž] | [@] [ðŸ˜€] | [Undo] [Redo]
```
- **B** - Bold
- **I** - Italic  
- **U** - Underline
- **S** - Strikethrough
- **H1/H2** - Headings
- **â€¢** - Bullet list
- **1.** - Numbered list
- **Link** - Insert hyperlink
- **ðŸ“Ž** - Attach currency/item
- **@** - Mention player
- **ðŸ˜€** - Emoji picker (optional)

## Files
| Action | Path | Description |
|--------|------|-------------|
| NEW | `src/lib/db/models/social/Message.ts` | Mongoose model |
| NEW | `src/lib/db/models/social/MessageThread.ts` | Thread model |
| NEW | `src/lib/types/messages.ts` | TypeScript types |
| NEW | `src/lib/validations/messages.ts` | Zod schemas |
| NEW | `src/lib/utils/sanitizeHtml.ts` | DOMPurify wrapper |
| NEW | `src/lib/utils/profanityFilter.ts` | bad-words wrapper |
| NEW | `src/app/api/messages/route.ts` | List/Create |
| NEW | `src/app/api/messages/[id]/route.ts` | Get/Update/Delete |
| NEW | `src/app/api/messages/[id]/reply/route.ts` | Reply |
| NEW | `src/app/api/messages/[id]/claim-attachment/route.ts` | Claim |
| NEW | `src/app/api/messages/sent/route.ts` | Sent |
| NEW | `src/app/api/messages/starred/route.ts` | Starred |
| NEW | `src/app/api/messages/trash/route.ts` | Trash |
| NEW | `src/app/api/messages/threads/route.ts` | Threads |
| NEW | `src/app/api/messages/threads/[threadId]/route.ts` | Thread detail |
| NEW | `src/app/api/messages/bulk/route.ts` | Bulk operations |
| NEW | `src/app/api/messages/unread-count/route.ts` | Unread count |
| NEW | `src/app/api/users/search/route.ts` | User search |
| NEW | `src/hooks/useMessages.ts` | SWR hooks |
| NEW | `src/components/messages/MessageLayout.tsx` | Layout |
| NEW | `src/components/messages/MessageSidebar.tsx` | Sidebar |
| NEW | `src/components/messages/MessageList.tsx` | List |
| NEW | `src/components/messages/MessageRow.tsx` | Row |
| NEW | `src/components/messages/MessageDetail.tsx` | Detail |
| NEW | `src/components/messages/MessageComposer.tsx` | Compose modal |
| NEW | `src/components/messages/RichTextEditor.tsx` | TipTap editor |
| NEW | `src/components/messages/EditorToolbar.tsx` | Toolbar |
| NEW | `src/components/messages/RecipientInput.tsx` | Autocomplete |
| NEW | `src/components/messages/AttachmentPanel.tsx` | Attachments |
| NEW | `src/components/messages/MentionList.tsx` | Mentions |
| NEW | `src/components/messages/ThreadView.tsx` | Thread |
| NEW | `src/components/messages/index.ts` | Barrel export |
| NEW | `src/app/game/messages/page.tsx` | Messages page |
| NEW | `src/app/game/messages/[id]/page.tsx` | Message detail page |
| NEW | `src/app/game/messages/compose/page.tsx` | Compose page |
| MOD | `src/lib/api/endpoints.ts` | Add message endpoints |
| MOD | `src/app/game/layout.tsx` | Add Messages nav item |
| MOD | `package.json` | Add TipTap + dependencies |

## Dependencies
- None (standalone feature)

## Database Indexes
```javascript
// Message collection
{ recipientId: 1, isDeletedByRecipient: 1, createdAt: -1 }  // Inbox
{ senderId: 1, isDeletedBySender: 1, createdAt: -1 }        // Sent
{ recipientId: 1, isRead: 1 }                                // Unread count
{ threadId: 1, createdAt: 1 }                                // Thread messages
{ recipientId: 1, isStarred: 1, createdAt: -1 }             // Starred
{ bodyPlainText: 'text', subject: 'text' }                   // Full-text search

// MessageThread collection
{ participantIds: 1, lastMessageAt: -1 }                     // User threads
```

## Security Considerations
- HTML sanitization with DOMPurify (whitelist safe tags only)
- XSS prevention on render
- Rate limiting: 10 messages/minute per user
- Profanity filter on subject + body
- Validate recipient exists before sending
- Prevent self-messaging
- Attachment claims are atomic (prevent double-claim)

## UX Polish
- Optimistic UI updates
- Skeleton loading states
- Empty states with illustrations
- Keyboard shortcuts (Ctrl+Enter to send)
- Draft auto-save to localStorage
- Notification sound on new message (optional)
- "Sending..." / "Sent âœ“" feedback
- Smooth animations on message actions

## Future Enhancements (Phase 2)
- Real-time WebSocket notifications
- Message search with filters
- Message templates / canned responses
- Block/mute players
- System messages (game events, achievements)
- Group messages (multiple recipients)
- Read receipts
- Message scheduling
- File attachments (images via upload)
