## Phase 7 Politics API Contract Matrix (Initial)
**Date:** 2025-11-27  
**Status:** PRE-IMPLEMENTATION (All endpoints NEW)  
**Context:** Achievements & Telemetry Phase 7 — utilities & models completed; API layer pending.

### Endpoints Overview
| Endpoint | Method | Purpose | Request Params/Body | Response Shape | Auth | Exists | Notes |
|----------|--------|---------|---------------------|----------------|------|--------|-------|
| /api/politics/achievements | GET | List achievement definitions + player unlock status | Query: playerId? (else session); optional `refresh=true` to force evaluation | `{ achievements: AchievementDefinition[], unlocks: { achievementId, repeatIndex, status, rewardApplied }[] }` | Session | NEW | Uses `evaluateAchievements` if refresh requested; otherwise cached + unlock query |
| /api/politics/achievements/redeem | POST | Apply achievement reward idempotently | Body: `{ achievementId: string, repeatIndex?: number }` | `{ ok: true, applied: boolean }` | Session | NEW | Calls `applyAchievementReward`; returns applied=false if already applied |
| /api/politics/telemetry/events | GET | Retrieve filtered raw telemetry events | Query: `playerId?`, `types?` (csv), `sinceEpoch?`, `limit?=100`, `offset?=0` | `{ events: TelemetryEvent[], pagination: { total, limit, offset, hasMore } }` | Session | NEW | Validates types against enum; restricts max limit (500) |
| /api/politics/telemetry/stats | GET | Fetch aggregated DAILY/WEEKLY rollups | Query: `playerId?`, `range?=recent` (recent|custom), `startEpoch?`, `endEpoch?` | `{ daily: Aggregate[], weekly: Aggregate[] }` | Session | NEW | Optionally triggers on-demand aggregate for current incomplete period |

### Coverage Summary
| Domain | Planned Endpoints | Existing | Coverage |
|--------|-------------------|----------|----------|
| Achievements | 2 | 0 | 0% |
| Telemetry Raw | 1 | 0 | 0% |
| Telemetry Aggregates | 1 | 0 | 0% |

**Overall Coverage:** 0/4 (0%). All endpoints require implementation — no frontend consumers yet (UI components pending). 

### Request / Response Validation Sources
- Achievement definitions & unlock contract: `src/lib/types/politicsPhase7.ts`
- Telemetry event discriminated union: `src/lib/schemas/politicsPhase7Telemetry.ts`
- Aggregation model: `src/lib/db/models/TelemetryAggregate.ts`

### Reuse / Dependencies
- Achievements: `evaluateAchievements`, `applyAchievementReward` (Phase 7 utilities)
- Telemetry: `TelemetryEventModel`, `telemetryEventLogger` for potential ingestion extension later
- Aggregation: `aggregateWindow`, `runDailyAggregation`, `runWeeklyAggregation`
- Auth: Existing pattern from `src/app/api/departments/route.ts` using `auth()`
- DB Connection: Reuse `connectDB` helper if present (`connectDB` import pattern in departments route)

### Preliminary Error Model
| Code | Scenario | Response | Notes |
|------|----------|----------|-------|
| 400 | Invalid query/body | `{ error: string }` | Zod and manual validation messages normalized |
| 401 | No session / unauthorized | `{ error: 'Unauthorized' }` | Check `session?.user?.id` |
| 404 | Player/company context missing | `{ error: 'Not Found' }` | If player/company cannot be resolved |
| 429 | Excessive limit request | `{ error: 'Limit too high' }` | Enforce max limit (500) on events |
| 500 | Unhandled server error | `{ error: 'Internal server error' }` | Logged with component logger |

### Security & Constraints
- Auth required for all endpoints; player context derived from session. Optional playerId overrides validated for ownership (to be implemented).
- Pagination enforced on telemetry events to prevent unbounded responses.
- Strict enum validation on event type filters.
- Achievement reward application idempotent (compound unique index & update guard).
- Aggregation fetch avoids heavy recomputation; on-demand aggregate limited to current period boundary.

### Implementation Order Recommendation
1. Achievements GET (foundation for UI + unlock status)
2. Achievements POST redeem (depends on unlock presence)
3. Telemetry events GET (raw explorer for debugging)
4. Telemetry stats GET (aggregated dashboard data)

### Go / No-Go
All endpoints green-lighted for implementation (no conflicting existing routes). Proceed with creation ensuring full validation & documentation.

---
*Generated by ECHO v1.3.1 (Phase 7 API initial contract matrix)*