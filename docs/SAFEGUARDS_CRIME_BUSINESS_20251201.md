# Safeguards: Optimistic Locking, Idempotency Keys, and Rate Limits (2025-12-01)

- Scope: Business + Crime endpoints (conversion, black-market, laundering, facilities)
- Status: Implemented and verified via TypeScript build (0 errors)

## Optimistic Locking
- Token options:
  - Header: `If-Unmodified-Since: <RFC1123/ISO timestamp>` (compared to `updatedAt`)
  - Body (PATCH only): `version: number` (compared to `__v`)
  - Body (PATCH only): `ifUnmodifiedSince: string` (ISO timestamp)
- Behavior:
  - `PATCH /api/business/[id]` requires a concurrency token; otherwise `428 Precondition Required`.
  - `DELETE /api/business/[id]` requires `If-Match-Version` or `If-Unmodified-Since`; otherwise `428`.
  - On mismatch (stale), returns `409 Conflict` with `{ error: 'Conflict: resource modified or not found' }`.
  - Success responses include `ETag: W/"v<version>"` and `Last-Modified` with the new timestamp.
- Conversion endpoint:
  - `POST /api/crime/conversion/convert` supports optional precondition via `If-Unmodified-Since` header or `facilityUpdatedAt` in body; on mismatch returns `409`.

## Persistent Idempotency Keys
- Header: `Idempotency-Key: <opaque-string>`
- Persistence: `IdempotencyKey` collection with TTL; fields include `scope`, `userId`, `requestHash`, `statusCode`, `summary`.
- Wrapper: `handleIdempotent(request, userId, execute, { scope })` ensures safe replay.
- Integrated endpoints (initial set):
  - `POST /api/business` (scope: `business:create`)
  - `POST /api/crime/conversion/convert` (scope: `crime:conversion`)
  - `POST /api/crime/black-market` (scope: `crime:black-market:create`)
  - `POST /api/crime/black-market/[id]/purchase` (scope: `crime:black-market:purchase`)
  - `POST /api/crime/facilities` (scope: `crime:facility:create`)
- Replay semantics:
  - Same key + same payload → returns a stored replay response with headers `Idempotency-Status: replayed`.
  - Same key + different payload → `409 Conflict` (key misuse).

## Rate Limits
- Implemented per-user (fallback per-IP) with standard headers.
- Examples: conversion (15/min), black-market purchase (20/min), facilities (30/min), market listing (25/min), laundering (20/min).

## Examples

### PATCH Business with version
```
PATCH /api/business/64fe...c19
If-Unmodified-Since: Tue, 02 Dec 2025 05:21:11 GMT
Content-Type: application/json

{
  "name": "Green Valley Dispensary",
  "taxRate": 8.5,
  "version": 3
}
```
Response (success): `200 OK` with `ETag: W/"v4"` and `Last-Modified`.

### DELETE Business with If-Unmodified-Since
```
DELETE /api/business/64fe...c19
If-Unmodified-Since: Tue, 02 Dec 2025 05:21:11 GMT
```
Response on stale: `409 Conflict`.

### Idempotent Business Create
```
POST /api/business
Idempotency-Key: 42f1f7e5-5a55-4d2e-9b8c-9f7db7d7a1aa
Content-Type: application/json

{ "name": "GVD", "ownerId": "u1", "category": "Dispensary", "address": { "state": "CA", "city": "LA" } }
```
Replay of same request returns `200/201` with `Idempotency-Status: replayed`.

---
Generated by ECHO v1.3.3 (Flawless) on 2025-12-01.
