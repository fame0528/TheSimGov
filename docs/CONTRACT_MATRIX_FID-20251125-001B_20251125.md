# Backend–Frontend Contract Matrix (Phase 2 Political Engagement)
**FID:** FID-20251125-001B  
**Date:** 2025-11-25  
**Schema Versions:** All political contracts v1  
**Status:** Discovery complete – all endpoints/components are GREENFIELD (none exist yet)  

## Overview
Phase 2 introduces player-only political engagement with deterministic fairness and environmental difficulty indices (SPI, VM, ES). This matrix enumerates planned API surfaces and associated frontend consumption points. All rows currently show Status = MISSING (no implementation yet). This document is the authoritative contract specification before coding begins.

Legend:  
- Status: MISSING (no code) | PLANNED (in matrix) | EXISTS (implemented)  
- Req: Request payload (Body | Query)  
- Resp: Response payload (JSON shape referencing TypeScript interfaces)  
- Gaps: Missing validations, dependencies, or legacy parity notes  

---
## Campaign Cycle & Phase State
| Endpoint | Method | Req | Resp | Status | Gaps |
|----------|--------|-----|------|--------|------|
| /api/politics/campaign/state | GET | query: playerId | { state: CampaignPhaseState } | MISSING | Auth, seed logging, caching layer |
| /api/politics/campaign/advance-phase | POST | body: { playerId } | { state: CampaignPhaseState, phaseTransition: { from, to } } | MISSING | Phase guard rules, time window validation |
| /api/politics/campaign/actions/fundraise | POST | body: { playerId, amount, source } | { updatedState: CampaignPhaseState, achievementEvents?: AchievementEvent[] } | MISSING | Amount caps, source enumeration, anti-spam throttle |
| /api/politics/campaign/actions/lobby | POST | body: { playerId, legislationId, spend } | { success: boolean, probability: number, updatedState: CampaignPhaseState } | MISSING | Legislation model ref, probability formula extension (influence + spend log + caps) |
| /api/politics/campaign/actions/endorsement | POST | body: { playerId, sourceCategory, sourceName, tier } | { endorsement: EndorsementRecord, updatedState: CampaignPhaseState } | MISSING | Duplicate prevention, diminishing returns curve reuse |
| /api/politics/campaign/actions/resolve-election | POST | body: { playerId } | { result: { win: boolean, votePercent: number }, updatedState: CampaignPhaseState } | MISSING | Election formula design, fairness clamps |

## Polling System
| Endpoint | Method | Req | Resp | Status | Gaps |
|----------|--------|-----|------|--------|------|
| /api/politics/polling/snapshots | GET | query: playerId, limit? | { snapshots: PollingSnapshot[] } | MISSING | Pagination, smoothing parameters | 
| /api/politics/polling/generate | POST | body: { playerId } | { snapshot: PollingSnapshot } | MISSING | Rate limit, seed collision policy |
| /api/politics/polling/aggregate | GET | query: playerId, windowHours | { aggregate: { mean: number, volatility: number, trend: 'UP'|'DOWN'|'STABLE' } } | MISSING | Trend derivation, window validation |

## Debate System
| Endpoint | Method | Req | Resp | Status | Gaps |
|----------|--------|-----|------|--------|------|
| /api/politics/debate/submit-performance | POST | body: { debateId, playerId, rhetorical, policy, charisma, penalties?[] } | { performance: DebatePerformance } | MISSING | Score normalization, penalty enum definition |
| /api/politics/debate/results | GET | query: debateId | { performances: DebatePerformance[] } | MISSING | Debate event model, ordering by performanceScore |

## Scandal & Mitigation
| Endpoint | Method | Req | Resp | Status | Gaps |
|----------|--------|-----|------|--------|------|
| /api/politics/scandals/active | GET | query: playerId | { scandals: ScandalRecord[] } | MISSING | Severity recalculation, status roll logic |
| /api/politics/scandals/mitigate | POST | body: { playerId, scandalId, actionCode } | { scandal: ScandalRecord } | MISSING | Action validation, recovery rate adjustments |
| /api/politics/scandals/generate | POST | body: { playerId, category? } | { scandal: ScandalRecord } | MISSING | Generation probability, category weighting |

## Endorsements
| Endpoint | Method | Req | Resp | Status | Gaps |
|----------|--------|-----|------|--------|------|
| /api/politics/endorsements/list | GET | query: playerId | { endorsements: EndorsementRecord[] } | MISSING | Expiry filtering |
| /api/politics/endorsements/acquire | POST | body: { playerId, sourceCategory, sourceName, tier } | { endorsement: EndorsementRecord } | MISSING | Duplicate guard, diminishing return factor calc reuse |
| /api/politics/endorsements/expire | POST | body: { endorsementId } | { success: boolean } | MISSING | Expiry rules, permission check |

## Achievements
| Endpoint | Method | Req | Resp | Status | Gaps |
|----------|--------|-----|------|--------|------|
| /api/politics/achievements/pending | GET | query: playerId | { events: AchievementEvent[] } | MISSING | Queue implementation |
| /api/politics/achievements/claim | POST | body: { playerId, achievementId } | { claimed: AchievementEvent } | MISSING | Reward application, idempotency |

## Leaderboards
| Endpoint | Method | Req | Resp | Status | Gaps |
|----------|--------|-----|------|--------|------|
| /api/politics/leaderboard | GET | query: metricType, seasonId? | { entries: LeaderboardEntry[] } | MISSING | Shared leaderboard consolidation with non-political metrics |
| /api/politics/leaderboard/player-rank | GET | query: playerId, metricType | { entry: LeaderboardEntry } | MISSING | Caching strategy, duplication with existing AI leaderboard type |

## WebSocket / Real-Time Channels (Planned)
| Channel | Events Out | Events In | Payload Contract | Status | Gaps |
|---------|------------|-----------|------------------|--------|------|
| /politics/campaign | phaseUpdate | requestPhaseAdvance | { state: CampaignPhaseState } | MISSING | Socket namespace creation, auth guard |
| /politics/polling | snapshotBroadcast | requestGenerateSnapshot | { snapshot: PollingSnapshot } | MISSING | Broadcast interval policy |
| /politics/debate | performanceBroadcast | submitPerformance | { performance: DebatePerformance } | MISSING | Debate orchestration, concurrency safety |
| /politics/leaderboard | leaderboardUpdate | requestLeaderboard | { entries: LeaderboardEntry[] } | MISSING | Cross-domain leaderboard merge |

## Data Type References
All response payload interfaces reside in `src/lib/types/politics.ts` (versioned with `schemaVersion: 1`). Deterministic seeds included for reproducibility in testing and auditing. Business logic utilities will extend existing `politicalinfluence.ts` rather than duplicate formulas.

## Validation & Security Notes
| Area | Concern | Planned Mitigation |
|------|---------|--------------------|
| Authorization | Prevent cross-player manipulation | Strict playerId ownership checks via session context |
| Rate Limiting | Fundraising / polling spam | Per-endpoint rolling window throttle (Redis or in-memory fallback) |
| Deterministic Seeds | Replay attacks | Pair seed with signed timestamp; reject duplicates within window |
| Input Validation | Tier/category enums | Zod schemas mirroring TypeScript enums |
| Fairness | Spend-based advantage escalation | Clamp logarithmic returns + diminishing endorsement factors |
| Data Integrity | Leaderboard rank recalculation | On-write recompute + periodic verification job |

## Legacy Parity Notes
- Legacy political endpoints (donate, eligibility, lobby) exist only for Phase 1; advanced debate, scandal, endorsement, and polling endpoints were not implemented – all greenfield here.
- Debate and scandal systems require new formulas; parity baseline = absence (no legacy logic to port, but must not regress existing influence mechanics).

## Gaps Summary
| Category | Count Missing | Primary Dependencies |
|----------|---------------|----------------------|
| REST Endpoints | 27 | Auth middleware, validation layer, persistence models |
| WebSocket Channels | 4 | server.js namespace extension, event schemas |
| Models/Schemas | 6 | Mongo/Prisma models for scandal, endorsement, debate, polling snapshot, achievement queue, election result |
| Utilities | 5 | Probability engine extension, endorsement diminishing curve, polling smoothing, scandal lifecycle, election resolution |

## Next Actions (Go / No-Go)
Current Coverage: 0% (all planned surfaces missing)  
Recommendation: Proceed with utility/model layer first (Types → Validation (Zod) → Persistence models → Core probability & smoothing utilities) before implementing REST/WebSocket surfaces.

1. Implement persistence models (scandal, endorsement, debatePerformance, pollingSnapshot, achievementEvent, campaignPhaseState)
2. Extend existing lobbying/influence utility with advanced formulas (probability & clamps)
3. Create validation schemas (Zod) matching politics contracts
4. Implement high-read GET endpoints first (state, snapshots, active scandals, endorsements, leaderboard)
5. Add write/action endpoints with atomic updates & deterministic seed logging
6. Introduce WebSocket channels after stable REST surfaces
7. Draft test harness for deterministic seed verification & edge cases

## Duplication Risks
- `LeaderboardEntry` exists in `CompetitiveLeaderboard.tsx` (AI context). Plan: unify via shared leaderboard type file and map domains with metric enum extension.

## Approval Checklist
| Item | Ready | Notes |
|------|-------|-------|
| Contracts Defined | ✅ | politics.ts versioned interfaces present |
| Endpoints Enumerated | ✅ | 27 REST, 4 WS planned |
| Legacy Parity Reviewed | ✅ | No advanced legacy endpoints to port |
| Validation Plan | ✅ | Zod schemas planned per interface |
| Security Considerations | ✅ | Ownership, rate limit, seed protection listed |
| Next Action Sequence | ✅ | Ordered implementation plan established |

**Go Decision:** YES – proceed to gap analysis & model/utility implementation planning.

---
*Generated by ECHO v1.3.0 (GUARDIAN Protocol Active) – Contract Matrix for Phase 2 Political Engagement*
